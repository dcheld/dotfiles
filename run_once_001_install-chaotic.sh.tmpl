#!/usr/bin/env bash

{{- if (eq .chezmoi.osRelease.id "arch") }}
set -e


echo "==> Obtem a primary key do repositório"

sudo pacman-key --recv-key 3056513887B78AEB --keyserver keyserver.ubuntu.com
sudo pacman-key --lsign-key 3056513887B78AEB

# Pacotes oficiais necessários

echo "==> Instalando keyring e mirrorlist..."
sudo pacman --noconfirm --needed -U 'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst'
sudo pacman --noconfirm --needed -U 'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst'

# Adicionar repositório se não existir
if ! grep -q "^\[chaotic-aur\]" /etc/pacman.conf; then
    echo "==> Adicionando repositório Chaotic-AUR ao /etc/pacman.conf"
    sudo bash -c 'cat >> /etc/pacman.conf <<EOF

[chaotic-aur]
Include = /etc/pacman.d/chaotic-mirrorlist
EOF'
else
    echo "==> Repositório Chaotic-AUR já existe em /etc/pacman.conf. Pulando."
fi

echo "==> Atualizando pacotes..."
sudo pacman -Syu --noconfirm

echo "==> Chaotic-AUR instalado com sucesso!"

{{- end }}
